---
title: "Historic Effects of Climate Change on Tree Crop Phenology in California"
author: |
  | Elise Hellwig^1^, Katherine Pope^2^, Robert J. Hijmans^1^
  | 1. University of California, Davis
  | 2. Cooperative Extension, University of California
header-includes: 
  - \usepackage{morefloats}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage[table]{xcolor}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage[normalem]{ulem}
output:
  pdf_document:
    fig_caption: yes
  word_document:
    fig_caption: yes
    reference_docx: phenologytemplate.docx
  html_document:
    fig_caption: yes
bibliography: phenology.bib
---


```{r, env_setup, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
#This is the set-up block of code, it loads all of the required libraries

library(tidyverse)
library(plyr)
library(knitr)
library(lubridate)
library(reshape2)
library(grid)
library(segmented)
library(kableExtra)
#library(qdap, warn.conflicts = FALSE)
library(mgsub)
library(kableExtra)

opts_chunk$set(tidy.opts=list(width.cutoff=60), 
               stringsAsFactors=FALSE,
               knitr.table.format = "latex",
               cache=TRUE,
               echo = FALSE)
options(warn=0)
#this makes it so numbers aren't put into scientific notation
#options(scipen=999)

###################################

#setwd('/Users/echellwig/Drive/Phenology/CA_Report')
#setwd("C:\\gdrive\\Phenology\\R\\CA_Report")
###################################

walnutcol <- 'green4' 
prunecol <- 'purple4'
almondcol <- 'darkgoldenrod3'

#data paths
sourcepath <- '/Users/echellwig/Research/phenology/functions'
data1 <- '/Volumes/GoogleDrive/My Drive/Phenology/CA_Results/'
data2 <- '/Volumes/GoogleDrive/My Drive/Phenology/data/historydata'
data3 <- '/Volumes/GoogleDrive/My Drive/Phenology/Results/history'
historypath <- '/Volumes/GoogleDrive/My Drive/Phenology/data/history'

source(file.path(sourcepath, 'multiplot.R'))
source(file.path(sourcepath, 'reportfunctions.R'))
source(file.path(sourcepath, 'extractlm.R'))



#data
weather <- read.csv(file.path(data2, 'weatherlocations.csv'))
ctemps <- read.csv(file.path(data1,'switchday.csv'))
fp <- readRDS(file.path(data1, 'floweringpredictors.RDS'))
slp <- readRDS(file.path(data1, 'seasonlengthpredictors.RDS'))


am <- read.csv(file.path(data2, 'annualtemperatures.csv'))
#am <- read.csv(file.path(data1, 'data/annualtemperatures.csv'))

amlabs <- read.csv(file.path(data2, 'temptrendlabels.csv'))
names(amlabs)[2] <- 'loc'

mtc <- read.csv(file.path(data2, 'monthlytemperatures.csv'))
mtcAvg <- dcast(mtc[,c('loc', 'year', 'nmonth', 'tavg')],
                loc + year ~ nmonth, value.var = 'tavg')

harvest <- readRDS(file.path(historypath, 'harvest.RDS'))
asl <- filter(harvest, crop=='almond', cultivar!='Sonora')
psl <- filter(harvest, crop=='prune')
wsl <- filter(harvest, crop=='walnut')
tts <- readRDS(file.path(historypath, 'ThermalTimeSeries.RDS'))
locVar <- read.csv(file.path(historypath, 'SeasonLengthParameters.csv'))


#Model table
modtable <- readRDS(file.path(historypath, 'ModelTable.RDS'))
atab <- modtable %>% 
    filter(crop=='almond') %>% 
    select(-crop)
ptab <- modtable %>% 
    filter(crop=='prune') %>% 
    select(-crop)
wtab <- modtable %>% 
    filter(crop=='walnut') %>% 
    select(-crop)

#Katherine's data

#Monthly and Total Winter Chill Accumulation for all sites (Chico, Davis, Modesto, Parlier)
pblm <- read.csv(file.path(data1, 'data/Bloom_Parlier_French_ksp.csv')) #Prune bloom at Parlier


locations <- c('Chico', 'Modesto', 'Parlier', 'Davis')
mos <- 1:12


```



## Notes

** Thesis: Temperature increases due to climate change vary by region in California. By looking at tree response to interannual temperature variation we can explain past phenological trends and predict future ones. **

- Need to add chill and heat sums over time
- Need to run linear models and then extract the interesting numbers
- Need to find a good way to plot all the things without having massive amounts of space in the graph (ex scaling the data)
- To be honest I my want to scale the data anyway for model fitting.


# Introduction

Tree crops, like almonds and walnuts, made up 35% of the California agricultural sector by income in 2012 and that percentage is increasing (Ag stats 2012). Almonds individually are the second highest valued commodity California produces, second only to milk and cream (Ag Stats 2015). Unlike field crops and other annuals that are replanted every spring, tree crops stay in the same place for multiple decades. They also require more upfront investment as most trees do not fruit until a couple years after planting. Because of this, they are more vulnerable to changes in climate. 

The effects of climate change in California are fairly well documented, especially with respect to drought (citations). However, the potential for groundwater based irrigation systems protects many agricultural systems from significant water stress during all but the most severe droughts (Citation?). Temperatures in California are also changing due to climate change and this many already have impacted the phenology for more sensitive crops (Luedeling 2012b). Many papers have has also been demonstrated temperature to be one of the key, if not the key climatic variable when predicting crop phenology (citations). 

However, it is not enough to just look at the predictors of flowering and harvest dates when assessing climate risk. It is also necessary to compare these predictors to actually flowering and harvest dates, and investigate changes to these dates over time. 

The majority of variation in California temperatures over the past 100 years is not due to climate change, but rather is inter-annual. Since temperature variablility between years is so great, we can use crops' phenological responses over many years to fit models relating temperature and crop phenology (citation). The effects of temperature on thermal time and flowering and leaf out have also been investigated for many crops in the Central Valley using this method (Luedeling 2012). The effects on harvest however, are not as well studied.

When discussing fall phenology, the most commonly referenced development stage is maturity, the first possible harvest date [@mimoun1998; @tombesi2010; @ruml2011]. However, maturity is correlated with flowering.  Everything else being equal, a tree that bloomed earlier will also be ready to harvest earlier. Consequently, changes in harvest readiness date can be due to changes in flowering dates and/or changes in temperature after flowering dates. To avoid confounding these two phenomena, we use season length (time from flowering to maturity) as the fall phenological response, instead of harvest date.

This paper documents temperature changes in California over the past century and relates those changes to changes in almond, prune and walnut phenology in the Central Valley. Realized temperature increases due to climate change vary by region in California. By looking at tree response to interannual temperature variation, we can explain past phenological trends and predict future ones.

# Methods

## Data

### Climate Data

Climate data for each of the focal orchard sites was obtained from the National Climatic Data Center (NCDC, Menne and Houston 2015) and from California Irrigation Management Information System (CIMIS, California Department of Water Resources 2015). The NCDC provided daily minumum and maxiumum temperature data going back to the early 1900s, and CIMIS provided hourly data back to 1983. A number of climate stations were chosen for each orchard location to ensure there would be data for every day in the time span of the orchard datasets for each location (Table 1). The closest station to the site with at least 85% completeness was chosen as the primary station. Temperature data from other stations was related to temperature data from the primary station via a linear regression. This model was then used to fill in gaps in the primary station’s data. In cases where there were nearby NCDC and CIMIS weather stations, one primary station was chosen for each data source.

### Phenological Data

Though the almond and walnut datasets have records for a large number of cultivars, only three will be analyzed – the earliest and latest cultivars to bloom and/or leaf-out, and the current most popular variety, which blooms in the middle. It is expected that if there is variability in response to warming, examining cultivars that cover the spectrum of phenological timing is the most likely way to reveal that variability. The prune industry in California is planted almost exclusively with one cultivar and thus only one cultivar will be analyzed.

Almond bloom and harvest records came from the University of California (UC) Regional Almond Variety Trial (RAVT). Data from the UC Regional Almond Variety Trial were recorded in Chico and Modesto by UC Cooperative Extension advisors assigned to the county where the data was recorded. The bloom record in a given year represents the average bloom of a number of trees of similar age in the same orchard. We report data for cultivars ‘Sonora’, ‘Nonpareil’, and ‘Mission’ which represent the range of bloom timing in commercially cultivated almonds. Prune bloom and harvest timing data was recorded by the University of California Prune Breeding, provided by current breeder Sarah Castro. Because the 'Improved French' cultivar makes up almost all of the prune acreage in California, it is the only prune cultivar analyzed. We used walnut phenology data from the University of California at Davis Walnut Breeding Program. Leaf out dates (LD) and Harvest readiness dates (HRD) were collected by Charles Leslie, Gale McGranahan and the members of the Walnut Improvement Program. The cultivars 'Chandler', 'Payne', and 'Franquette' were chosen as cultivars that both span the range of flowering and harvest dates as well as having long data records (>30 years).


## Analysis

All analysis was completed in R Statistical Programming Environment [@r2018] using the 'phenoclim' package (citation) to estimate thermal time accumulation parameters. 

### Climate Analysis

We investigated temperature trends in the four orchard locations in the Central Valley: Chico, Davis, Modesto, and Parlier. Temperature time series going back to 1931 were analyzed to match up with the duration of the longest phenological time series (almond bloom in Chico). While most of the phenological time series do not extend this far back, it is necessary to examine a long time series for climate data to ensure that the trends we find are robust. We analyzed both the monthly and annual temperature time series with a first degree autoregressive linear model, due the presence of autocorrelation in the data [@cressie2015]. 


```{r weatherlocs}

kable(weather, booktabs = TRUE, 
      col.names = c('Source', 'Location', 'Orchard Location','Start','End', ''),
      caption = 'NCDC and CIMIS weather station information by orchard
                    location.')


```


### Phenological Analysis

Season lengths for almonds and prunes started at full bloom, while walnut season length began at leaf-out. Maturity for almonds and walnuts was counted at hull-split while prunes were considered mature at 3-4 lbs of pressure. All phenological data were analyzed separately by location and cultivar using ordinary linear regression, and segmented regression (citation) when it was deemed necessary. 

Thermal time was calculated using the asymcur model described by [@anderson1986]. We used the 'phenoclim' package to determine the optimal number of days of thermal time accumulation after bloom or leaf-out to use for predicting season length for each cultivar/location pair using 'phenoclim' package. Thermal time accumulation was then calculated for each year with bloom or leaf-out data. Next we related thermal time accumulation to season length using linear models. Finally, we examined trends in thermal time accumulation over the entire bloom time series for each cultivar and location.


#Results

## Temperature Trends


```{r annual_min_plot, warning=FALSE, echo=FALSE, fig.cap='Mean Annual Minimum Temperatures from 1930 to 2017, duration of phenology record shown with grey lines.', fig.height=5, fig.width=6, tidy=TRUE}

am_min <- am[am$variable=='tmin',]
labs_min <- amlabs[amlabs$variable=='tmin', ]

minplot <- ggplot(data=am_min) + ylim(5,13) +
    geom_line(aes(x=year, y=temp), color='blue3') + facet_wrap(~loc) +
    geom_smooth(aes(x=year, y=temp), size=1, method='lm', se=FALSE,
                color="black", formula = y ~ x) + 
     geom_segment(data=labs_min, aes(x=start, y=segy, xend=end, yend=segy),
                  color='darkgrey', size=2) + 
    geom_text(data=labs_min, aes(x=end, y=texty, label=label), hjust=1, vjust=0,
              size=3) + theme_bw(10) + 
    labs(x='Year', y=expression("Temperature  "(~degree*C)))

minplot

```


```{r annual_max_plot, warning=FALSE, echo=FALSE, fig.cap='Mean Annual Minimum Temperatures from 1930 to 2017, duration of phenology record shown with grey lines.', fig.height=5, fig.width=6, tidy=TRUE}

am_max <- am[am$variable=='tmax',]
labs_max <- amlabs[amlabs$variable=='tmax', ]

maxplot <- ggplot(data=am_max) + ylim(21,28) +
    geom_line(aes(x=year, y=temp), color='red3') + facet_wrap(~loc) +
    geom_smooth(aes(x=year, y=temp), size=1, method='lm', se=FALSE,
                color="black", formula = y ~ x) + 
     geom_segment(data=labs_max, aes(x=start, y=segy, xend=end, yend=segy),
                  color='darkgrey', size=2) + 
    geom_text(data=labs_max, aes(x=end, y=texty, label=label), hjust=1, vjust=0,
              size=3) + theme_bw(10) + 
    labs(x='Year', y=expression("Temperature  "(~degree*C)))

maxplot

```



Over the past 80 years, annual temperatures minimum temperatures have stayed roughly the same in Chico but the annual maximum temperature has increased by 0.085  &deg;C (Table 5, Figures 2-3). No monthly minimum temperatures in Chico exhibit any significant trends. However, January, February, and December monthly maximum temperatures show significant increasing trends (Table 5).

Modesto minimum temperatures show the strongest warming trends of all the locations, with a mean increase of 0.2 &deg;C per decade (Figure 3, Table 2). In addition, all mean minimum temperatures show significant increases in all months except for January and the means from eight months increased at over 0.3&deg;C per decade (Table 2). The annual maximum temperature in Modesto is also increasing, but not as rapidly (Figure 4, Table 5). Also, only seven months exhibit significant positive thrends in temperature (Table 5).


```{r chico_table, warning=FALSE,echo=FALSE}
chico <- filter(mtc, loc=='Chico')
achico <- am[am$loc=='Chico', ]


#running linear model and extracting coefficients and pvalues for monthly values
cmin <-  t(sapply(mos, function(m) arf('tmin', 'year', m, chico) ))
cmax <- t(sapply(mos, function(m) arf('tmax', 'year', m, chico) ))
cavg <- t(sapply(mos, function(m) arf('tavg', 'year', m, chico) ))

# #running linear model etc for annual data
cann <- t(sapply(unique(am$variable), function(v) arf('temp', 'year', NA, achico[achico$variable==v, ])))

#merging data
cmin <- rbind(cmin,cann[1,])
cmax <- rbind(cmax,cann[2,])
cavg <- rbind(cavg,cann[3,])

ctable <- data.frame(Month=c(month.name, 'Annual'), 
                     Minimum=signif(cmin[,1]*10,2), 
                     pvaln=signif(cmin[,2],2), 
                     Maximum=signif(cmax[,1]*10,2), 
                     pvalx=signif(cmax[,2],2), 
                     Average=signif(cavg[,1]*10,2),
                     pvala=signif(cavg[,2],2))

#cell_spec(Month, italic=ifelse(Month='Annual', TRUE, FALSE))

ctable %>% mutate(Month=Month,
                  Minimum = cell_spec(Minimum, bold = sig(pvaln)),
                  pvaln = cell_spec(pvaln, bold = sig(pvaln)),
                  Maximum = cell_spec(Maximum, bold = sig(pvalx)),
                  pvalx = cell_spec(pvalx, bold = sig(pvalx)),
                  Average = cell_spec(Average, bold = sig(pvala)),
                  pvala = cell_spec(pvala, bold = sig(pvala))) %>% 
    kable(digits=2, booktabs=TRUE, 
          col.names=c('Month', 'Minimum','p-value', 'Maximum', 'p-value',
                  'Average', 'p-value'), 
          caption='Average change per decade of Chico minimum, maximum, and mean monthly temperatures from 1931-2014. Change is considered significant and given in bold if p-values are under 0.05.')
    
```




Modesto minimum temperatures show the strongest warming trends of all the locations, with a mean increase of 0.2 &deg;C per decade (Figure 2, Table 6). In addition, all mean minimum temperatures show significant increases in all months except for January and the means from eight months increased at over 0.3 &deg;C per decade (Table 6). The annual maximum temperature in Modesto is also increasing, but not as rapidly (Figure 3, Table 6). Also, only seven months exhibit significant positive thrends in temperature (Table 6).



```{r modesto_table,warning=FALSE, echo=FALSE}
modesto <- filter(mtc, loc=='Modesto')
amodesto <- filter(am, loc=='Modesto')

#running AR model and extracting coefficients and pvalues

mmin <-  t(sapply(mos, function(m) arf('tmin', 'year', m, modesto) ))
mmax <- t(sapply(mos, function(m) arf('tmax', 'year', m, modesto) ))
mavg <- t(sapply(mos, function(m) arf('tavg', 'year', m, modesto) ))

mann <- t(sapply(unique(am$variable), function(v) arf('temp', 'year', NA, amodesto[amodesto$variable==v, ])))

#merging data
mmin <- rbind(mmin,mann[1,])
mmax <- rbind(mmax,mann[2,])
mavg <- rbind(mavg,mann[3,])

mtable <- data.frame(Month=c(month.name, 'Annual'), 
                     Minimum=signif(mmin[,1]*10,2), 
                     pvaln=signif(mmin[,2],2), 
                     Maximum=signif(mmax[,1]*10,2), 
                     pvalx=signif(mmax[,2],2), 
                     Average=signif(mavg[,1]*10,2),
                     pvala=signif(mavg[,2],2))

#cell_spec(Month, italic=ifelse(Month='Annual', TRUE, FALSE))

mtable %>% mutate(Month=Month,
                  Minimum = cell_spec(Minimum, bold = sig(pvaln)),
                  pvaln = cell_spec(pvaln, bold = sig(pvaln)),
                  Maximum = cell_spec(Maximum, bold = sig(pvalx)),
                  pvalx = cell_spec(pvalx, bold = sig(pvalx)),
                  Average = cell_spec(Average, bold = sig(pvala)),
                  pvala = cell_spec(pvala, bold = sig(pvala))) %>% 
    kable(digits=2, booktabs=TRUE, 
          col.names=c('Month', 'Minimum','p-value', 'Maximum', 'p-value',
                  'Average', 'p-value'), 
          caption='Average change per decade of Modesto minimum, maximum, and mean monthly temperatures from 1931-2014. Change is considered significant and given in bold if p-values are under 0.05.')

```



In Davis, annual minimum temperatures have risen an average of 0.21&deg;C per decade over the past 80 years based on an autoregressive linear analysis (Figure 2). Annual maximum temperatures, however, have stayed fairly constant (Figure 3). Davis monthly minimum temperatures exhibit strong warming trends in the spring, summer and fall, with temperatures increasing between 0.15&deg;C and 0.26&deg;C per decade in months where a significant change was detected (Table 16). January maximum temperatures in also show a significant warming trend (0.17&deg;C per decade), but it is the only month we have strong evidence of maximum temperatures increasing. In addition, mean maximum temperatures in July display a slight cooling trend (Table 7).


Davis monthly minimum temperatures exhibit strong warming trends in the spring, summer and fall, with temperatures increasing between 0.15&deg;C and 0.26&deg;C per decade in months where a significant change was detected (Table 16). January maximum temperatures in also show a significant warming trend (0.17&deg;C per decade), but it is the only month we have strong evidence of maximum temperatures increasing. In addition, mean maximum temperatures in July display a slight cooling trend (Table 16).



```{r davis_table, echo=FALSE, warning=FALSE}
davis <- mtc[mtc$loc=='Davis', ]
adavis <-  am[am$loc=='Davis', ]

#running AR model and extracting coefficients and pvalues
dmin <-  t(sapply(mos, function(m) arf('tmin', 'year', m, davis) ))
dmax <- t(sapply(mos, function(m) arf('tmax', 'year', m, davis) ))
davg <- t(sapply(mos, function(m) arf('tavg', 'year', m, davis) ))

#annual stuff
dann <-  t(sapply(unique(am$variable), function(v) arf('temp', 'year', NA, adavis[adavis$variable==v, ])))

#merging data
dmin <- rbind(dmin,dann[1,])
dmax <- rbind(dmax,dann[2,])
davg <- rbind(davg,dann[3,])


dtable <- data.frame(Month=c(month.name,'*Annual*'), Minimum=sig2(dmin[,2], v2=dmin[,1]*10), pvaln=sig2(dmin[,2]), Maximum=sig2(dmax[,2], v2=dmax[,1]*10), pvalx=sig2(dmax[,2]), Average=sig2(davg[,2], v2=davg[,1]*10), pvala=sig2(davg[,2]))

kable(dtable, digits=2, col.names=c('Month', 'Minimum','p-value', 'Maximum', 'p-value', "Average", "p-value"), caption='Average change per decade of Davis minimum, maximum, and average monthly temperatures from 1931-2014. Change is considered significant and given in bold if p-values are under 0.05.')

```


Annually Parlier exhibits warming minimum temperatures and cooling maximum temperatures (Figures 2-3) based on an autoregressive linear model of data since 1931. While the cooling trend in the mean annual maximum temperature is stronger (-0.36°C per decade), the warming trend in the mean annual minimum temperature is still highly significant (Table 8). Minimum monthly temperatures are increasing year round based on autoregression analysis, but only spring, summer, and fall maximum temperatures are cooling significantly (Table 8).

```{r parlier_table, warning=FALSE,echo=FALSE}
parlier <- mtc[mtc$loc=='Parlier', ]
aparlier <- am[am$loc=='Parlier', ]

#running AR model and extracting coefficients and pvalues
pmin <-  t(sapply(mos, function(m) arf('tmin', 'year', m, parlier) ))
pmax <- t(sapply(mos, function(m) arf('tmax', 'year', m, parlier) ))
pavg <- t(sapply(mos, function(m) arf('tavg', 'year', m, parlier) ))

pann <-  t(sapply(unique(am$variable), function(v) arf('temp', 'year', NA, aparlier[aparlier$variable==v, ])))

#merging data
pmin <- rbind(pmin,pann[1,])
pmax <- rbind(pmax,pann[2,])
pavg <- rbind(pavg,pann[3,])

mtable <- data.frame(Month=c(month.name,'*Annual*'), Minimum=sig2(pmin[,2], v2=pmin[,1]*10), pvaln=sig2(pmin[,2]), Maximum=sig2(pmax[,2], v2=pmax[,1]*10), pvalx=sig2(pmax[,2]), Averague=sig2(pavg[,2], v2=pavg[,1]*10), pvala=sig2(pavg[,2]))

kable(mtable, digits=2, col.names=c('Month', 'Minimum','p-value', 'Maximum', 'p-value','Average', 'p-value'), caption='Average change per decade of Parlier minimum and maximum monthly temperatures from 1931-2014. Change is considered significant and given in bold if p-values are under 0.05.')

```






## Model Optimization

Length of optimized thermal time accumulation varied significantly between crop, location and cultivar (Table 6). Accumulation lengths varied from 35 days for Mission almonds in Modesto to 74 days for prunes in Parlier. 

```{r locVarTable}

kable(locVar[,-c(5,6)], booktabs = TRUE, 
      col.names = c('Crop', 'Location', 'Cultivar','Length'),
      caption = 'Optimized length of thermal time accumulation in days for
      predicting season length, by crop, location and cultivar.')

```


## Almonds


Mean almond season lengths did not appear to decrease over the 10 years of the Regional Almond Variety Trials. (Figure 3). However because the time series are so short, we cannot make any longterm predictions based on this. Almond season lengths respond fairly well to optimized thermal time accumulation (Figure 4, Table 7), though the model relating thermal time accumulation for Nonpareil Almonds to season length in Modesto was not strongly significant. 


```{r almond_harvest_year, fig.cap='Almond season lengths over 10 years in Chico, California.', warning=FALSE, echo=FALSE, fig.height=4}

amy <- ggplot(data=asl) + facet_grid(loc~cultivar) + theme_bw() +
    geom_point(aes(x=year, y=length1), size=1.5, color=almondcol) +
    labs(x='year',y='Season Length (days)')

amy

```


```{r almond_harvestthermal, fig.cap='Almond season length by heat sum in Chico, California.', warning=FALSE, echo=FALSE, fig.height=4}

amat <- ggplot(data=asl) + facet_grid(loc~cultivar, scales='free_x') +
    geom_point(aes(x=thermal, y=length1), size=1.5, color=almondcol) +
    labs(x='Scaled Heat Sum',y='Season Length (days)') + theme_bw() +
    stat_smooth(aes(x=thermal, y=length1), method='lm', col='black')

amat

```

In Chico, both thermal time accumation for both Mission and Nonpareil cultivars increased singificantly over the past 75 years (Figure 5). Thermal time accumulation actually decreased in Modesto for both cultivars, though the time series is not quite as long, so we cannot be as confident that this trend will continue into the future. Additionally, it is unclear why this would be the case. 

```{r almondHarvThermTable}


```



```{r almond_gdhtime, fig.cap='Almond heat sums over 80 years in Chico and Modesto, California.', warning=FALSE, echo=FALSE, fig.height=4}
atts <- filter(tts, crop=='almond')

agdh <- ggplot(data=atts) + facet_grid(loc~cultivar) + theme_bw() +
    geom_point(aes(x=year, y=thermal), size=1.5, color=almondcol) +
    labs(x='year',y='Heat Sum')

agdh

```


```{r almondThermTimeTable}


ALengthMod <- lapply(alist, function(df) {
    lm(length1 ~ thermal, data=df)
})

AThermalTimeMod <- lapply(attlist, function(df) {
    lm(thermal ~ year, data=df)
})

atab1 <- formatLM(aLocVar, ALengthMod)

atab2 <- formatLM(aLocVar, AThermalTimeMod)

kable(atab2, booktabs = TRUE, 
      col.names = c('Location', 'Cultivar', 'Coefficient','p-value', 'R2'),
      caption = 'Linear regression summary for models of optimized thermal time
      accumulation over the past 75 years. Coefficient units are in
      growing degree hours per year.', digits=2)

```



## Prunes


French Prune season lengths in Parlier shortened by an average of 0.49 days per year over the past 25 years, with a p-value of 0.041 and an adjusted R-squared of 0.160 (Figure 6). Prune season length responded strongly to the optimized thermal time accumulation (Figure 7). However, 



```{r prune_harvest_year, fig.cap='Prune season lengths over 25 years in Parlier, California.', warning=FALSE, echo=FALSE, fig.height=2.5, fig.width=4}

pmy <- ggplot(data=psl) + theme_bw() +
    geom_point(aes(x=year, y=length1), size=1.5, color=prunecol) +
    labs(x='year',y='Season Length (days)')

pmy

```


Fruit development thermal time accumulation values for French prunes in Parlier exhibit increasing trends using both models (Figure 44, Table 14). However, there is too much variation in the data to make any strong conclusions. Given the trends present in the monthly data though, it is likely that spring thermal accumulation values will continue to increase. Conversely the mean maximum May temperatures appear to be decreasing slightly (Table 12), which would indicate that prune season lengths will get longer based on the model in Figure 30. However, given that the thermal time accumulation model is more biologically accurate, it is likely to be more reliable. In this case, using monthly temperatures as an indicator of season length is misleading.

Given the trend of increasing fruit development thermal time accumulation in Parlier (Figure 44), Improved French prune season lengths will most likely continue to shrink with increasing climate change. 


```{r prune_harvest, fig.cap='Prune season lengths by heat sum in Parlier, CA.', warning=FALSE, echo=FALSE, fig.height=2.5, fig.width=4}

pmat <- ggplot(data=psl) + theme_bw() + 
    geom_point(aes(x=thermal, y=length1), size=1.5, color=prunecol) +
    labs(x='Scaled Heat Sum',y='Season Length (days)')

pmat

```



```{r prune_heatsumtime,  fig.cap='Prune heat sum over 25 years in Parlier, CA.', warning=FALSE, echo=FALSE, fig.height=2.5, fig.width=4}

ptts <- filter(tts, crop=='prune')
pghd <- ggplot(data=psl) + theme_bw() + 
    geom_point(aes(x=year, y=thermal), size=1.5, color=prunecol) +
    labs(x='Year',y='Scaled Heat Sum')

pghd

```




## Walnuts


Mean season length in Payne walnuts decreased significantly over the past 50 years (Figure 58). Chandler and Franquette season lengths seem to have stayed fairly stable. However, because of the variability in the data, it is possible that a longer time series will exhibit a significant trend. This is particularly relevant for Chandler walnuts, as they were only developed in the last 50 years. 



Payne is the only walnut cultivar whose mean season length shows significant change (decrease) over the past 60 years (Figure 58). Payne season length also responded to warmer April and May temperatures (Figure 59). As monthly minimum temperatures are increasing for both April and May in Davis (Table 16), it very likely that the season length of Payne walnuts will continue to get shorter over time. Additionally, Payne season length responded strongly to fruit development thermal time accumulation during the first two months after leaf-out (Figure 60, Table 19). The fact that Payne thermal time accumulation has been increasing over the past half-century is further evidence that mean season length for Payne walnuts will shorten with increasing climate change (Figure 61, Table 19).



```{r walnut_harvest_year, fig.cap='Walnut season lengths over the past 60 years for Chandler, Franquette and Payne Cultivars.', warning=FALSE, echo=FALSE, fig.height=2.5}

wmy <- ggplot(data=wsl) + facet_wrap(~cultivar) + theme_bw() +
    geom_point(aes(x=year, y=length1), size=1.5, color=walnutcol) +
    labs(x='year',y='Season Length (days)')

wmy

```



While Chandler season length does not show a significant trend over time it does exhibit a complex response to monthly temperatures (Figure 62).  Warmer temperatures in March lead to shorter seasons, while warmer temperatures in April and May correlate with longer ones. Because March, April, and May all show warming trends in Davis (Table 16), we cannot yet tell how climate change will effect Chandler season length based on monthly temperatures. 


 
Chandler season length responds strongly to thermal time accumulation in the first thirty days after leaf-out as well (Figure 63). The trends in thermal accumulation in both models indicate that it is likely that Chandler season lengths will get shorter, even though a significant trend has not yet been detected (Figure 63-64, Table 19). It is unclear biologically why warmer temperatures in April correlate with longer season lengths, while fruit development thermal time accumulation in parts of March and April correlate with shorter season length (Figure 62-63). It may be that the correlation between April temperatures and season length is spurious.






```{r walnut_harvest, fig.cap='Heat sum correlation with walnut season lengths over the past 60 years in Davis.', warning=FALSE, echo=FALSE, fig.height=2.5}

wmat <- ggplot(data=wsl) + facet_wrap(~cultivar, scales='free_x') + theme_bw() +
    geom_point(aes(x=thermal, y=length1), size=1.5, color=walnutcol) +
    labs(x='Scaled Heat Sum',y='Season Length (days)')

wmat



```



While Franquette mean season length did not significantly correlate with mean temperatures from any month, it did respond to thermal time accumulation during the first 37 days after leaf-out (Figure 65, Table 19). As fruit development thermal time accumulation (calculated using the simplified model), is increasing (Figure 66, Table 19), we would expect that mean season length for Franquette walnuts will decrease as the climate warms. However, due to the amount of noise in the data, it may take a while before this trend becomes clear.



```{r walnut_heatsumtime, fig.cap='Walnut heat sums over the past 80 years.', warning=FALSE, echo=FALSE, fig.height=6, fig.width=5}

wtts <- filter(tts, crop=='walnut')
wgdh <- ggplot(data=wsl) + facet_wrap(~cultivar, scale='free_y',nrow=3) +
    theme_bw() +
    geom_point(aes(x=year, y=thermal), size=1.5, color=walnutcol) +
    labs(x='Year',y='Scaled Heat Sum')

wgdh



```



# Conclusions

##Climate

The climate of California has not changed uniformly across the state. Modesto, Parlier, and Davis have all experienced increases in minimum annual temperatures, but the trends in their annual maximum temperatures diverge. Modesto maximum temperatures are warming, though not as quickly as the minimum temperatures. In Davis, maximum temperatures are relatively stable, and in Parlier, annual highs are actually decreasing. Additionally, both minimum and maximum temperatures in Chico are fairly stable.

## Spring Phenology

### Almond
No changes were found in the timing of bloom, nor monthly or total chill accumulation for Chico or Modesto. The only change seen was in the timing of meeting the heat requirement for Sonora and Nonpareil, the two earlier blooming cultivars, in Modesto (the warmer location) and for Nonpareil in Chico. 

It is not surprising that in Chico, where we found no change in minimum temperatures, there would be no change in chill accumulation or bloom timing. The earlier satisfaction of the heat requirement for Nonpareil in Chico is in keeping with the increased maximum temperatures in December, January and February in Chico. It is, however, difficult to explain why this was not reflected in the timing of meeting the heat requirement for the other two cultivars.

Mean monthly minimum and maximum temperatures increased every month in Modesto. It is more difficult to explain why no change was seen in bloom timing or chill accumulation in Modesto given these changes in temperature. The lack of change in chill accumulation was mirrored in the lack of change in the timing of the chill requirement being met. The increased temperatures were reflected in the earlier meeting of the heat requirement in the Nonpareil and Sonora cultivars. This may not yet have translated into a change in the timing of bloom due to the connection between chill and heat accumulation necessary for bloom.

### Prune
Bloom was found to be coming later for prunes in Parlier since 1988. Chill accumulation was found to be increasing over time for January, February and winter as a whole. This is discordant with the finding of increased mean monthly minimum temperatures in November, January, February and March, unless increased temperatures have raised some temperatures into the range giving the most chill value - between 6&deg;-8&deg;C (43&deg;-47&deg;F). Despite this change in chill accumulation, no change was found in the timing of the chill and heat requirements being met. With increased winter chill accumulation and no change in heat accumulation, one would expect bloom to be coming earlier on average, not later. More research is needed to attempt to explain if and how the change in bloom timing is related to changing temperature. 

### Walnut
For walnuts in Davis, leaf-out, our marker of spring phenology, was detected as coming later for all three cultivars since 1988. No change was found for chill accumulation in November or December, however a potential increase in chill accumulation was detected towards the end  of the century for January (since 1970) and February (1988). This change in chill accumulation does not synch with the lack of finding of significant change in minimum temperature in those months. It does, however, correspond with a finding of the chill requirement for Payne walnuts being met earlier. However, it is confusing that this was not also the finding regarding the timing of meeting the chill requirement for Chandler or Franquette. Furthermore, it is difficult to explain, in light of the increase in chill, why leaf-out has coming later in recent decades. With increased chill accumulation, one would expect leaf-out to come earlier with an earlier satisfaction of the chill requirement. More research is needed to attempt to explain if and how the change in leaf-out timing is related to changing temperature.

In short, while there is a clear signal of changing timing of spring phenology in prunes and walnuts, it is not clear if and how temperature is affecting that change.

## Fall Phenology

### Almonds
Given the length of the almond season length time series, we cannot draw any strong conclusions. However, if things continue as they have been over the ten years examined, Mission almond season lengths may potentially continue to shorten.

### Prunes

French prune season lengths have gotten, on average, 12 days shorter since 1988. The trends in the May monthly temperatures (Table 7) and the relationship between the thermal time accumulation and season length (Figure 31) both point to a continuation of this trend with continued warming due to climate change. 

### Walnuts

Payne walnut season lengths have shortened by approximately 11 days since 1960. Based on the upwards trends in the thermal time accumulation (Figure 49)  as well as April and May temperatures (Table 9), Payne season lengths will continue to get shorter as climate change intensifies. Chandler season lengths have not changed appreciably over the past 50 years. However, the increasing thermal time accumulation (Figure 52) indicates that season lengths will shorten in the future. Franquette season length shows a similar pattern to Chandler season length. It has yet to exhibit any trend, but the increasing trend in thermal accumulation for Franquette walnuts indicate that it is likely Franquette season lengths will get shorter in the future (Figure 54).



#References

